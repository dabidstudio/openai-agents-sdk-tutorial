from agents import Agent, Runner, handoff
from pydantic import BaseModel
from typing import List
import asyncio
from agents.extensions.handoff_prompt import RECOMMENDED_PROMPT_PREFIX



# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì—¬í–‰ í”Œë˜ë„ˆ (ìµœì¢… ì—ì´ì „íŠ¸)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
travel_planner_agent = Agent(
    name="Travel Planner",
    instructions="""
    ë‹¹ì‹ ì€ ë„ì›€ì´ ë˜ëŠ” ì—¬í–‰ í”Œë˜ë„ˆì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ëª…í™•í•œ ì—¬í–‰ ìš”êµ¬ì‚¬í•­ì´ ì£¼ì–´ì§€ë©´,
    ëª©ì ì§€ ì œì•ˆ, í™œë™, ìƒ˜í”Œ ì¼ì •ì„ í¬í•¨í•œ ì—¬í–‰ ê³„íšì„ ìƒì„±í•˜ì„¸ìš”.
    ì¹œê·¼í•˜ê³  ì²´ê³„ì ì¸ í˜•ì‹ìœ¼ë¡œ í•œêµ­ì–´ë¡œ ì‘ë‹µí•˜ì„¸ìš”.
    """
)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ëª…í™•í™” ì—ì´ì „íŠ¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
clarifier_agent = Agent(
    name="Clarifier Agent",
    instructions="""
    ì‚¬ìš©ìì˜ ì—¬í–‰ ë¬¸ì˜ê°€ ë„ˆë¬´ ëª¨í˜¸í•˜ê±°ë‚˜ ì¤‘ìš”í•œ ì •ë³´ê°€ ë¶€ì¡±í•œ ê²½ìš°, 2-3ê°œì˜ í›„ì† ì§ˆë¬¸ì„ í†µí•´ ëª…í™•íˆ í•˜ì„¸ìš”.
    ë¬¸ì˜ê°€ ì´ë¯¸ ëª…í™•í•œ ê²½ìš° `transfer_to_instruction_builder`ë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ì„¸ìš”.
    ì˜ˆì‹œ ì§ˆë¬¸:
    - ì–´ë–¤ ì—¬í–‰ì§€ë¥¼ ìƒê°í•˜ê³  ê³„ì‹ ê°€ìš”?
    - ì–¸ì œ ì—¬í–‰í•˜ì‹¤ ê³„íšì¸ê°€ìš”?
    - ì˜ˆì‚°ì€ ì–´ëŠ ì •ë„ì¸ê°€ìš”?
    - ìì—°, ëª¨í—˜, ë¬¸í™”, íœ´ì‹ ì¤‘ ì–´ë–¤ ê²ƒì„ ì°¾ìœ¼ì‹œë‚˜ìš”?

    ëª¨ë“  ì§ˆë¬¸ì€ í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ì„¸ìš”.
    """,
    handoffs=[travel_planner_agent]
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë¶„ë¥˜ ì—ì´ì „íŠ¸ (ì‹œì‘ì )
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
triage_agent = Agent(
    name="Triage Agent",
    instructions="""
    ì‚¬ìš©ìì˜ ë¬¸ì˜ê°€ ì—¬í–‰ ê³„íšì— ì‚¬ìš©ë  ì¤€ë¹„ê°€ ë˜ì—ˆëŠ”ì§€ íŒë‹¨í•˜ì„¸ìš”.
    
    - í•µì‹¬ ì •ë³´ê°€ ë¶€ì¡±í•œ ê²½ìš° `transfer_to_clarifier_agent` í˜¸ì¶œ
    - ìš”ì²­ì´ ëª…í™•í•˜ê³  ì˜ ëª…ì‹œëœ ê²½ìš° `transfer_to_instruction_builder` í˜¸ì¶œ
    
    í•˜ë‚˜ì˜ í•¨ìˆ˜ í˜¸ì¶œë§Œ ë°˜í™˜í•˜ì„¸ìš”.
    ëª¨ë“  ì‘ë‹µì€ í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ì„¸ìš”.
    """,
    handoffs=[clarifier_agent, travel_planner_agent]
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Runner
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def travel_chat():
    print("\nğŸ§³ ì—¬í–‰ ê³„íšì„ ë„ì™€ë“œë¦´ê²Œìš”! ì§ˆë¬¸í•´ì£¼ì„¸ìš” (exit ì…ë ¥ ì‹œ ì¢…ë£Œ)\n")

    user_input = input("ì‚¬ìš©ì: ")
    if user_input.strip().lower() == "exit":
        print("ì•ˆë…•íˆ ê°€ì„¸ìš”!")
        return

    messages = [{"role": "user", "content": user_input}]
    clarification_rounds = 0
    MAX_ROUNDS = 5

    while True:
        response = await Runner.run(triage_agent, input=messages)
        # 1. ëª…í™•í•œ ì •ë³´ë¥¼ ìœ„í•œ ì¶”ê°€ ì§ˆë¬¸ì´ í•„ìš”í•œ ê²½ìš°
        print("í˜„ì¬ ì—ì´ì „íŠ¸: ", response.last_agent.name)
        if response.last_agent.name == "Clarifier Agent":
            clarification_rounds += 1
            if clarification_rounds > MAX_ROUNDS:
                print("\nâš ï¸ ë„ˆë¬´ ë§ì€ ì§ˆë¬¸ ë°˜ë³µìœ¼ë¡œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.")
                break
            print(response.final_output)
            user_reply = input("\nì¶”ê°€ ë‹µë³€: ")
            messages.append({"role": "user", "content": user_reply})
            continue

        # 2. ì—¬í–‰ ì—ì´ì „íŠ¸ë¡œ ìš”ì²­ì´ ì „ë‹¬ëœ ê²½ìš° â†’ ìµœì¢… ì‘ë‹µ ì¶œë ¥
        print(f"\nì—¬í–‰ ì—ì´ì „íŠ¸: {response.final_output}")
        messages.append({"role": "assistant", "content": str(response.final_output)})
        break

if __name__ == "__main__":
    asyncio.run(travel_chat())
